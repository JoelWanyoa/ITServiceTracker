{% extends "base.html" %}
{% load static %}

{% block title %}{% if is_my_requests %}My Service Requests{% else %}All Service Requests{% endif %} - IT Service Tracker{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <!-- Header Section -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-8">
    <div class="mb-4 sm:mb-0">
      <h1 class="text-3xl font-bold text-gray-900">
        {% if is_my_requests %}My Service Requests{% else %}All Service Requests{% endif %}
      </h1>
      <p class="mt-2 text-gray-600">
        {% if is_my_requests %}
          Track and manage your service requests
        {% else %}
          Manage all service requests across the organization
        {% endif %}
      </p>
    </div>
    
    <div class="flex flex-col sm:flex-row gap-3">
      <a href="{% url 'requests_app:submit_request' %}" class="btn-primary inline-flex items-center justify-center px-4 py-2 text-sm font-medium">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
        </svg>
        New Request
      </a>
      
      {% if user.is_staff and not is_my_requests %}
      <a href="{% url 'requests_app:ui_dashboard' %}" class="btn-secondary inline-flex items-center justify-center px-4 py-2 text-sm font-medium">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
        </svg>
        Dashboard
      </a>
      {% endif %}
    </div>
  </div>

  <!-- Filters and Search -->
  {% if user.is_staff and not is_my_requests %}
  <div class="card bg-white rounded-xl shadow-sm p-6 mb-6">
    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
      <div class="flex flex-col sm:flex-row gap-3 flex-1">
        <select id="statusFilter" class="form-select rounded-lg border-gray-300 text-sm px-4 py-2 w-full sm:w-48">
          <option value="">All Statuses</option>
          <option value="Pending">Pending</option>
          <option value="In Progress">In Progress</option>
          <option value="Resolved">Resolved</option>
        </select>
        
        <select id="categoryFilter" class="form-select rounded-lg border-gray-300 text-sm px-4 py-2 w-full sm:w-48">
          <option value="">All Categories</option>
          <option value="Password Reset">Password Reset</option>
          <option value="Printer Issue">Printer Issue</option>
          <option value="Software Installation">Software Installation</option>
          <option value="Network Problem">Network Problem</option>
          <option value="Other">Other</option>
      </select>
        
        <div class="relative flex-1 max-w-md">
          <input type="text" id="searchInput" placeholder="Search requests..." class="form-input pl-10 pr-4 py-2 rounded-lg border-gray-300 text-sm w-full" />
          <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
          </svg>
        </div>
      </div>
      
      <button id="clearFilters" class="btn-secondary px-4 py-2 text-sm font-medium whitespace-nowrap">
        Clear Filters
      </button>
    </div>
  </div>
  {% endif %}

  <!-- Requests Table -->
  <div class="card bg-white rounded-xl shadow-sm overflow-hidden">
    {% if requests %}
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">ID</th>
            {% if user.is_staff and not is_my_requests %}
            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Requester</th>
            {% endif %}
            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Department</th>
            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Category</th>
            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Status</th>
            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Created</th>
            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Actions</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200 bg-white">
          {% for req in requests %}
          <tr class="hover:bg-gray-50 transition-colors duration-150 request-row" 
              data-status="{{ req.status }}" 
              data-category="{{ req.category }}"
              data-search="{{ req.id }} {{ req.requester_name }} {{ req.department|default:'' }} {{ req.category }} {{ req.status }} {{ req.created_at|date:'M d, Y' }}">
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm font-semibold text-gray-900">#{{ req.id }}</div>
            </td>
            
            {% if user.is_staff and not is_my_requests %}
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm font-medium text-gray-900">{{ req.requester_name }}</div>
            </td>
            {% endif %}
            
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-600">{{ req.department|default:"-" }}</div>
            </td>
            
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="flex items-center">
                <span class="category-badge category-{{ req.category|lower|slugify }} text-xs font-medium px-2.5 py-0.5 rounded-full">
                  {{ req.category }}
                </span>
              </div>
            </td>
            
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="status-badge status-{{ req.status|lower|slugify }} text-xs font-semibold px-3 py-1 rounded-full">
                {{ req.status }}
              </span>
            </td>
            
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-600">{{ req.created_at|date:"M d, Y" }}</div>
              <div class="text-xs text-gray-400">{{ req.created_at|date:"h:i A" }}</div>
            </td>
            
            <td class="px-6 py-4 whitespace-nowrap">
              <a href="{% url 'requests_app:detail_request' req.id %}" 
                 class="btn-view inline-flex items-center text-sm font-medium text-blue-600 hover:text-blue-900">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                </svg>
                View
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <!-- Empty State -->
    <div class="text-center py-16">
      <div class="mx-auto w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mb-4">
        <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
        </svg>
      </div>
      <h3 class="text-lg font-medium text-gray-900 mb-2">No requests found</h3>
      <p class="text-gray-500 mb-6 max-w-md mx-auto">
        {% if is_my_requests %}
          You haven't submitted any service requests yet. Create your first request to get started.
        {% else %}
          No service requests have been submitted yet. Requests will appear here once users start submitting them.
        {% endif %}
      </p>
      <a href="{% url 'requests_app:submit_request' %}" class="btn-primary inline-flex items-center px-4 py-2 text-sm font-medium">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
        </svg>
        Submit New Request
      </a>
    </div>
    {% endif %}
  </div>
</div>

<style>
  .stat-card {
    border-radius: 12px;
    padding: 1rem;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
  }
  
  .status-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  
  .status-pending {
    background-color: #fef3cd;
    color: #856404;
  }
  
  .status-in-progress {
    background-color: #cce7ff;
    color: #004085;
  }
  
  .status-resolved {
    background-color: #d4edda;
    color: #155724;
  }
  
  .category-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  
  .category-hardware {
    background-color: #e2e3ff;
    color: #3730a3;
  }
  
  .category-software {
    background-color: #cffafe;
    color: #0c4a6e;
  }
  
  .category-network {
    background-color: #ccfbf1;
    color: #115e59;
  }
  
  .category-account {
    background-color: #ffedd5;
    color: #9a3412;
  }
  
  .category-other {
    background-color: #f3f4f6;
    color: #374151;
  }
  
  .btn-primary {
    background-color: #2563eb;
    color: white;
    border-radius: 8px;
    transition: background-color 0.2s;
  }
  
  .btn-primary:hover {
    background-color: #1d4ed8;
  }
  
  .btn-secondary {
    background-color: #f3f4f6;
    color: #374151;
    border-radius: 8px;
    transition: background-color 0.2s;
  }
  
  .btn-secondary:hover {
    background-color: #e5e7eb;
  }
  
  .btn-view {
    transition: color 0.2s;
  }
  
  .card {
    border-radius: 12px;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
  }
  
  .form-input, .form-select {
    border: 1px solid #d1d5db;
    border-radius: 8px;
  }
  
  .form-input:focus, .form-select:focus {
    border-color: #3b82f6;
    outline: none;
    ring: 2px;
    ring-color: #3b82f6;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Filter functionality
    const statusFilter = document.getElementById('statusFilter');
    const categoryFilter = document.getElementById('categoryFilter');
    const searchInput = document.getElementById('searchInput');
    const clearFilters = document.getElementById('clearFilters');
    const requestRows = document.querySelectorAll('.request-row');
    
    function filterRequests() {
      const statusValue = statusFilter ? statusFilter.value.toLowerCase() : '';
      const categoryValue = categoryFilter ? categoryFilter.value.toLowerCase() : '';
      const searchValue = searchInput ? searchInput.value.toLowerCase() : '';
      
      requestRows.forEach(row => {
        const rowStatus = row.getAttribute('data-status').toLowerCase();
        const rowCategory = row.getAttribute('data-category').toLowerCase();
        const rowSearchText = row.getAttribute('data-search').toLowerCase();
        
        // Status filter: exact match
        const statusMatch = !statusValue || rowStatus === statusValue;
        
        // Category filter: contains match (any category that contains the selected word)
        const categoryMatch = !categoryValue || rowCategory.includes(categoryValue);
        
        // Search filter: contains match in any field
        const searchMatch = !searchValue || rowSearchText.includes(searchValue);
        
        if (statusMatch && categoryMatch && searchMatch) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
    }
    
    // Add event listeners if elements exist
    if (statusFilter) statusFilter.addEventListener('change', filterRequests);
    if (categoryFilter) categoryFilter.addEventListener('change', filterRequests);
    if (searchInput) searchInput.addEventListener('input', filterRequests);
    if (clearFilters) {
      clearFilters.addEventListener('click', function() {
        if (statusFilter) statusFilter.value = '';
        if (categoryFilter) categoryFilter.value = '';
        if (searchInput) searchInput.value = '';
        filterRequests();
      });
    }
    
    // Initialize filters if URL parameters exist
    function initializeFiltersFromURL() {
      const urlParams = new URLSearchParams(window.location.search);
      const status = urlParams.get('status');
      const category = urlParams.get('category');
      
      if (status && statusFilter) {
        statusFilter.value = status;
      }
      if (category && categoryFilter) {
        categoryFilter.value = category;
      }
      
      if (status || category) {
        filterRequests();
      }
    }
    
    initializeFiltersFromURL();
  });
</script>
{% endblock %}